<ion-header class="chat-header animated-gradient">
  <ion-toolbar>

    <!-- Back Button -->
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="goBack()" class="back-button">
        <ion-icon name="chevron-back" class="hover-scale"></ion-icon>
      </ion-button>
    </ion-buttons>

    <!-- User info -->
    <div class="user-info" (click)="showUserProfile()">
      <ion-avatar class="user-avatar pulse-online" *ngIf="user?.getMainAvatar()">
        <img [src]="user?.getMainAvatar()" alt="Profile" />
        <div *ngIf="user?.online" class="online-badge"></div>
      </ion-avatar>

      <div class="user-text">
        <h2 class="user-name">{{ user?.fullName }}</h2>
        <p class="user-status">
          <span *ngIf="user?.online" class="online">Online</span>
          <span *ngIf="!user?.online" class="offline">
            Last seen {{ user?.lastSeenText }}
          </span>
        </p>
      </div>
    </div>

    <!-- Video call buttons -->
<!-- header video button -->
<ion-buttons slot="end">
  <!-- Non-friend button -->
  <ion-button *ngIf="!user?.isFriend && canRequestVideoCall()"
              (click)="onVideoButtonPressed()"
              shape="round" fill="clear" class="video-button hover-pop pulse-icon"
              style="position:relative">

    <!-- outline until accepted -->
    <ion-icon [name]="activeVideoCall.status === 'accepted' ? 'videocam' : 'videocam-outline'"
              size="large"></ion-icon>

    <!-- show ? for non-friends unless accepted -->
    <div *ngIf="activeVideoCall.status !== 'accepted'"
         style="position:absolute;top:2px;right:2px;background:var(--ion-color-danger);color:#fff;font-size:10px;border-radius:50%;width:16px;height:16px;display:flex;justify-content:center;align-items:center;">
      ?
    </div>
  </ion-button>

  <!-- Friend button (never shows ?) -->
  <ion-button *ngIf="user?.isFriend"
              [routerLink]="['/messages/video', user?.id]"
              shape="round" fill="clear" class="video-button hover-pop">
    <ion-icon name="videocam"></ion-icon>
  </ion-button>
</ion-buttons>




  </ion-toolbar>
</ion-header>


<app-loader *ngIf="pageLoading"></app-loader>

<!-- Product card -->
<ion-card *ngIf="product" (click)="showUproduct()" class="product-card">
  <ion-row>
    <ion-col size="4">
      <ion-img [src]="getProductImage(product)" class="product-image"></ion-img>
    </ion-col>
    <ion-col size="8">
      <ion-card-header>
        <ion-card-title class="product-title">{{ product?.label }}</ion-card-title>
        <ion-card-subtitle class="product-price">{{ product?.price | currency:product?.currency }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content class="product-description">
        {{ product?.description }}
      </ion-card-content>
    </ion-col>
  </ion-row>
</ion-card>

<ion-content #content class="chat-content">
  <ion-infinite-scroll #infScroll position="top" (ionInfinite)="getMessages($event)"
    [disabled]="infScroll.disabled || pageLoading">
    <ion-infinite-scroll-content
      loadingSpinner="crescent"
      loadingText="Loading more messages...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <div class="messages-container">
    <ng-container *ngFor="let group of groupedMessages">
      <!-- Date separator -->
      <div class="date-separator">
        <span>{{ group.date }}</span>
      </div>
      
      <!-- Messages in this group -->
      <div *ngFor="let message of group.messages" class="message-wrapper">
        <div class="message-bubble" 
             [class.my-message]="message?.isMine(authUser?.id)"
             [class.their-message]="!message?.isMine(authUser?.id)"
             [class.failed]="message?.state === 'failed'">
          
          <!-- Image message -->
          <img *ngIf="message?.image" [src]="message?.image" class="message-image">
          
          <!-- Text content -->
          <div class="message-text" *ngIf="message?.text">
            {{ message?.text }}
          </div>
          
          <!-- Video call request -->
<!-- IF message sent by me -->
<!-- IF message sent by me -->
<!-- Video Call Request Message -->
<div *ngIf="message?.type === 'video-call-request'" 
     class="video-call-request"
     [ngClass]="{ 'improved-request': message?.from === authUser?.id,
                  'fancy-request': message?.from !== authUser?.id }">

  <!-- Icon -->
  <div class="video-icon-container" *ngIf="message?.from !== authUser?.id">
    <ion-icon name="videocam" class="video-icon pulse"></ion-icon>
  </div>
  <ion-icon *ngIf="message?.from === authUser?.id" name="videocam" class="video-icon"></ion-icon>

  <!-- Request text -->
  <div class="request-text">
    <strong>
      {{ message?.from === authUser?.id ? 'Video Call Request' : 'Incoming Video Call' }}
    </strong><br />
    {{ message?.text }}

    <!-- Pending: buttons -->
<!-- Pending: buttons -->
<!-- actions are shown only for the latest pending request, during this session -->
<div class="action-buttons" *ngIf="isActionableCall(message)">
  <ion-button *ngIf="message?.from !== authUser?.id"
              fill="outline" size="small" color="success"
              (click)="acceptVideoCall(message)">
    Accept
  </ion-button>

  <ion-button fill="outline" size="small" color="danger"
              (click)="cancelVideoCallRequest(message)">
    Cancel
  </ion-button>
</div>


    <!-- Accepted: resolved text -->
    <div *ngIf="message?.status === 'accepted'" class="resolved-text">
      <ng-container *ngIf="message?.from === authUser?.id">
        ✅ Accepted by {{ user?.fullName }}
      </ng-container>
      <ng-container *ngIf="message?.from !== authUser?.id">
        ✅ You accepted the call
      </ng-container>
    </div>

    <!-- Cancelled: resolved text -->
    <div *ngIf="message?.status === 'cancelled'" class="resolved-text">
      <ng-container *ngIf="message?.from === authUser?.id">
        ❌ You cancelled the request
      </ng-container>
      <ng-container *ngIf="message?.from !== authUser?.id">
        ❌ {{ user?.fullName }} cancelled the request
      </ng-container>
    </div>
  </div>
</div>

          
          <!-- Message metadata -->
          <div class="message-meta">
            <span class="message-time">{{ formatMessageTime(message.createdAt) }}</span>
            <span *ngIf="message?.state === 'sending'" class="message-status">
              <ion-spinner name="dots"></ion-spinner>
            </span>
            <span *ngIf="message?.state === 'sent'" class="message-status">
              <ion-icon name="checkmark-done"></ion-icon>
            </span>
          </div>
          
          <!-- Resend button for failed messages -->
          <ion-button *ngIf="message?.state === 'failed'" 
                      fill="clear" 
                      size="small" 
                      class="resend-button"
                      (click)="resendMessage(message)">
            <ion-icon name="refresh"></ion-icon>
          </ion-button>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Chat limits messages -->
  <div class="chat-limits" *ngIf="messages && !conversationStarted()">
    You can't send more messages until '{{ user?.fullName }}' responds
  </div>
  <div class="chat-limits" *ngIf="user && messages && !nonFriendsChatEnabled()">
    You have reached the message limit for non-friends
  </div>
</ion-content>

<ion-footer class="message-input-footer">
  <ion-toolbar>
    <ion-item lines="none" class="input-container">
      
      <!-- Toggle + Button -->
      <ion-button slot="start" fill="clear" (click)="toggleMediaOptions()" class="camera-button">
        <ion-icon name="add"></ion-icon>
      </ion-button>

      <!-- Conditionally shown media options -->
      <div *ngIf="showMediaOptions" class="media-options">
        <ion-button fill="clear" (click)="pickMedia('image')" class="camera-button">
          <ion-icon name="camera"></ion-icon>
        </ion-button>

        <ion-button fill="clear" (click)="pickMedia('video')" class="camera-button">
          <ion-icon name="videocam"></ion-icon>
        </ion-button>
      </div>

      <!-- Message Input -->
      <ion-input
        [(ngModel)]="messageText"
        (keyup.enter)="addMessage()"
        [disabled]="!conversationStarted() || !nonFriendsChatEnabled()"
        placeholder="Type a message"
        class="message-input">
      </ion-input>

      <!-- Image Preview -->
      <div *ngIf="image" class="image-preview">
        <img [src]="image" alt="Preview" style="max-height: 150px;">
        <ion-button fill="clear" size="small" color="danger" (click)="removeImage()">
          <ion-icon name="close-circle"></ion-icon>
        </ion-button>
      </div>

      <!-- Send Button -->
      <ion-button slot="end" fill="clear" (click)="addMessage()"
        [disabled]="!messageText && !image"
        class="send-button">
        <ion-icon name="send"></ion-icon>
      </ion-button>

    </ion-item>
  </ion-toolbar>
</ion-footer>
