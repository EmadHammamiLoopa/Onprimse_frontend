<app-loader *ngIf="pageLoading"></app-loader>

<ion-content fullscreen color="dark" class="video-container">
  <!-- Loading overlay while data / permissions are loading -->
  <div *ngIf="!user || !partner || placingCall || answeringCall"
       class="loading-overlay">
    <ion-spinner></ion-spinner>
    <div>Loading call interface...</div>
  </div>

  <!-- Actual call UI -->
  <ng-container *ngIf="user && partner">

    <!-- Remote video (starts big) -->
    <video #partnerVideo id="partner-video"
           autoplay playsinline muted preload="auto"
           (click)="swapVideo('my-video')"
           [ngClass]="{
             'main-video' : topVideoFrame === 'partner-video',
             'small-video': topVideoFrame !== 'partner-video'
           }">
    </video>

    <!-- Local preview (starts small) -->
    <video #myVideo id="my-video"
           autoplay playsinline muted preload="auto"
           (click)="swapVideo('partner-video')"
           [ngClass]="{
             'main-video' : topVideoFrame === 'my-video',
             'small-video': topVideoFrame !== 'my-video'
           }">
    </video>

    <!-- Ringing / incoming banner -->
    <div class="call-info" *ngIf="!answered">
      <ion-avatar>
        <img [src]="partner?.mainAvatar || 'assets/default-avatar.png'"
             [alt]="partner?.fullName || 'Caller avatar'"
             (error)="partner.mainAvatar = 'assets/default-avatar.png'" />
      </ion-avatar>

      <div class="user-name">{{ partner?.fullName }}</div>

      <div class="call-status">
        <span *ngIf="!answer">ðŸ“ž Calling...</span>
        <span *ngIf="answer">ðŸ“² Incoming Call</span>
      </div>
    </div>

    <!-- Connected call duration -->
    <div class="call-duration" *ngIf="answered">
      {{ callDuration }}
    </div>

    <!-- Bottom control panel -->
    <div class="controls-container">

      <!-- Row 1: accept / dial / hang-up -->
      <div class="button-row">
        <!-- Answer (callee, ringing) -->
        <ion-fab-button *ngIf="answer && !answered"
                        color="success"
                        (click)="answerCall()"
                        [disabled]="answeringCall"
                        aria-label="Answer Call">
          <ion-spinner *ngIf="answeringCall"></ion-spinner>
          <i *ngIf="!answeringCall" class="fas fa-phone"></i>
        </ion-fab-button>

        <!-- Place call (caller, before connected) -->
        <ion-fab-button *ngIf="!answered && !answer && !calling"
                        color="primary"
                        (click)="placeCall()"
                        [disabled]="placingCall"
                        aria-label="Start Call">
          <ion-spinner *ngIf="placingCall"></ion-spinner>
          <i *ngIf="!placingCall" class="fas fa-video"></i>
        </ion-fab-button>

        <!-- Hang-up BEFORE connection is established -->
        <ion-fab-button *ngIf="!answered"
                        color="danger"
                        (click)="cancel()"
                        [disabled]="endingCall"
                        aria-label="Cancel Call">
          <ion-spinner *ngIf="endingCall"></ion-spinner>
          <i *ngIf="!endingCall" class="fas fa-phone-slash"></i>
        </ion-fab-button>

        <!-- Hang-up AFTER connection -->
        <ion-fab-button *ngIf="answered"
                        color="danger"
                        (click)="closeCall()"
                        [disabled]="endingCall"
                        aria-label="End Call">
          <ion-spinner *ngIf="endingCall"></ion-spinner>
          <i *ngIf="!endingCall" class="fas fa-phone-slash"></i>
        </ion-fab-button>
      </div> <!-- /button-row -->

      <!-- Row 2: media toggles -->
      <div class="button-row" *ngIf="answered || !answer">
        <ion-fab-button [color]="audioEnabled ? 'light' : 'danger'"
                        (click)="toggleAudio()"
                        aria-label="Toggle Microphone">
          <i class="fas"
             [ngClass]="{
               'fa-microphone'      : audioEnabled,
               'fa-microphone-slash': !audioEnabled
             }"></i>
        </ion-fab-button>

        <ion-fab-button [color]="cameraEnabled ? 'light' : 'danger'"
                        (click)="toggleCamera()"
                        aria-label="Toggle Camera">
          <i class="fas"
             [ngClass]="{
               'fa-video'      : cameraEnabled,
               'fa-video-slash': !cameraEnabled
             }"></i>
        </ion-fab-button>

        <ion-fab-button color="light"
                        (click)="toggleCameraDirection()"
                        [disabled]="switchingCamera"
                        aria-label="Switch Camera">
          <ion-spinner *ngIf="switchingCamera"></ion-spinner>
          <i *ngIf="!switchingCamera" class="fas fa-sync-alt"></i>
        </ion-fab-button>
      </div> <!-- /button-row -->

    </div> <!-- /controls-container -->
  </ng-container>
</ion-content>
